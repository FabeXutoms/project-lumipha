// Prisma Schema - MySQL için optimize edilmiş
// Dokümantasyon: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Müşteri modeli
model Client {
  id                   Int       @id @default(autoincrement())
  name                 String    @db.VarChar(255)
  email                String    @db.VarChar(255)
  emailHash            String    @unique @map("email_hash") @db.VarChar(255)
  phoneHash            String?   @map("phone_hash") @db.VarChar(255)
  otpCode              String?   @map("otp_code") @db.VarChar(10)
  otpExpiresAt         DateTime? @map("otp_expires_at") @db.DateTime(0)
  previousOtpCode      String?   @map("previous_otp_code") @db.VarChar(10)
  previousOtpExpiresAt DateTime? @map("previous_otp_expires_at") @db.DateTime(0)
  phone                String?   @db.VarChar(255) // Increased length for encryption validation
  createdAt            DateTime  @default(now()) @map("created_at") @db.DateTime(0)

  // İlişkiler
  projectActions ProjectAction[]

  @@map("clients")
}

// Proje hareketleri modeli
model ProjectAction {
  id               Int       @id @default(autoincrement())
  clientId         Int       @map("client_id")
  trackingCode     String    @unique @db.VarChar(20) @map("tracking_code")
  packageName      String    @db.VarChar(255) @map("package_name")
  totalAmount      Decimal   @db.Decimal(10, 2) @map("total_amount")
  status           Status    @default(Pending)
  startDate        DateTime  @db.Date @map("start_date")
  estimatedEndDate DateTime? @db.Date @map("estimated_end_date")
  companyName      String?   @map("company_name") @db.Text
  businessType     String?   @map("business_type") @db.Text
  businessScale    String?   @map("business_scale") @db.Text
  projectLink      String?   @map("project_link") @db.Text

  // İlişkiler
  client   Client    @relation(fields: [clientId], references: [id])
  payments Payment[]

  @@index([clientId])
  @@map("project_actions")
}

// Ödeme modeli
model Payment {
  id              Int       @id @default(autoincrement())
  projectActionId Int       @map("project_action_id")
  amount          Decimal   @db.Decimal(10, 2)
  paymentDate     DateTime  @default(now()) @map("payment_date") @db.DateTime(0)
  paymentMethod   String?   @db.VarChar(100) @map("payment_method")
  transactionId   String    @unique @db.VarChar(255) @map("transaction_id")

  // İlişkiler
  projectAction ProjectAction @relation(fields: [projectActionId], references: [id])

  @@index([projectActionId])
  @@map("payments")
}

// Proje durumları - MySQL ENUM tipi
enum Status {
  WaitingForApproval @map("Onay Bekliyor")
  Pending            @map("Beklemede")
  InProgress         @map("Devam Ediyor")
  Completed          @map("Tamamlandı")
  Cancelled          @map("Iptal Edildi")

  @@map("project_status")
}

// İletişim formu mesajları modeli
model ContactMessage {
  id        Int      @id @default(autoincrement())
  fullName  String   @db.VarChar(255) @map("full_name")
  email     String   @db.VarChar(255)
  phone     String   @db.VarChar(50)
  message   String   @db.Text
  createdAt DateTime @default(now()) @map("created_at") @db.DateTime(0)
  isRead    Boolean  @default(false) @map("is_read")

  @@map("contact_messages")
}

// Yönetici modeli
model Admin {
  id           Int        @id @default(autoincrement())
  name         String     @unique @db.VarChar(50)
  passwordHash String     @map("password_hash") @db.VarChar(255)
  createdAt    DateTime   @default(now()) @map("created_at") @db.DateTime(0)
  
  auditLogs    AuditLog[]

  @@map("admins")
}

// Denetim Günlüğü modeli
model AuditLog {
  id             Int      @id @default(autoincrement())
  adminId        Int      @map("admin_id")
  action         String   @db.VarChar(50) // e.g. "POST /projects"
  targetEndpoint String   @map("target_endpoint") @db.VarChar(255)
  payload        String?  @db.Text
  createdAt      DateTime @default(now()) @map("created_at") @db.DateTime(0)
  
  admin          Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId])
  @@map("audit_logs")
}